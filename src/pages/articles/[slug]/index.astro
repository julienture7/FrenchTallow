---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { products } from '../../../data/config';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map(article => ({
    params: { slug: article.data.slug },
    props: { article }
  }));
}

const { article } = Astro.props;
const { title, body, product, product_name, product_link, product_image, language, angle, generated_at } = article.data;

// Parse markdown body to HTML
function parseMarkdown(text: string): string {
  return text
    // Headers
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // Bold
    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.*?)\*/gim, '<em>$1</em>')
    // Paragraphs
    .split('\n\n')
    .map(p => p.trim())
    .filter(p => p)
    .map(p => {
      if (p.startsWith('<h') || p.startsWith('<ul') || p.startsWith('<ol')) {
        return p;
      }
      return `<p>${p.replace(/\n/g, '<br>')}</p>`;
    })
    .join('\n');
}

const htmlContent = parseMarkdown(body);
const productData = products[product as keyof typeof products];
const formattedDate = new Date(generated_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout
  title={`${title} | FrenchTallowSoap`}
  description={body.substring(0, 160)}
  lang={language}
  canonicalUrl={`https://frenchtallow.com/articles/${article.data.slug}/`}
>
  <article class="article-page">
    <div class="container">
      <header class="article-header">
        <div class="article-meta">
          <span class="article-tag">{angle.replace(/_/g, ' ')}</span>
          <span class="article-tag product">{product_name}</span>
        </div>
        <h1>{title}</h1>
        <time datetime={generated_at}>{formattedDate}</time>
      </header>

      <div class="article-content" set:html={htmlContent} />

      <aside class="product-cta">
        <div class="product-cta-inner">
          <img
            src={`/assets/images/${product_image}`}
            alt={product_name}
            width="120"
            height="120"
            loading="lazy"
          />
          <div class="product-cta-content">
            <h3>{product_name}</h3>
            {productData && <p class="product-benefits">{productData.scentBenefits}</p>}
            <a href={product_link} target="_blank" rel="noopener" class="product-cta-btn">
              Shop on Etsy &rarr;
            </a>
          </div>
        </div>
      </aside>

      <nav class="article-nav">
        <a href="/" class="back-link">&larr; Back to Home</a>
      </nav>
    </div>
  </article>
</BaseLayout>

<style>
  .article-page {
    padding: var(--space-3xl) 0;
  }

  .article-page .container {
    max-width: var(--content-width);
  }

  .article-header {
    margin-bottom: var(--space-2xl);
  }

  .article-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .article-tag {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
  }

  .article-tag.product {
    background: var(--earth-deep);
    color: var(--text-inverse);
  }

  .article-header h1 {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    margin-bottom: var(--space-md);
    line-height: 1.3;
  }

  .article-header time {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .article-content {
    font-size: 1.0625rem;
    line-height: 1.8;
  }

  .article-content :global(h2) {
    font-size: 1.5rem;
    margin-top: var(--space-2xl);
    margin-bottom: var(--space-md);
  }

  .article-content :global(h3) {
    font-size: 1.25rem;
    margin-top: var(--space-xl);
    margin-bottom: var(--space-sm);
  }

  .article-content :global(p) {
    margin-bottom: var(--space-lg);
    color: var(--text-secondary);
  }

  .article-content :global(strong) {
    color: var(--text-primary);
    font-weight: 600;
  }

  .product-cta {
    margin-top: var(--space-3xl);
    padding: var(--space-xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
  }

  .product-cta-inner {
    display: flex;
    gap: var(--space-xl);
    align-items: center;
  }

  .product-cta img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: var(--radius-md);
    flex-shrink: 0;
  }

  .product-cta-content h3 {
    font-size: 1.25rem;
    margin-bottom: var(--space-xs);
  }

  .product-benefits {
    font-size: 0.9375rem;
    color: var(--text-muted);
    font-style: italic;
    margin-bottom: var(--space-md);
  }

  .product-cta-btn {
    display: inline-block;
    background: var(--earth-deep);
    color: var(--text-inverse);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 0.9375rem;
    transition: background 0.2s ease;
  }

  .product-cta-btn:hover {
    background: var(--earth-warm);
  }

  .article-nav {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--bg-tertiary);
  }

  .back-link {
    font-size: 0.9375rem;
    color: var(--sage);
    font-weight: 500;
  }

  .back-link:hover {
    color: var(--earth-warm);
  }

  @media (max-width: 600px) {
    .product-cta-inner {
      flex-direction: column;
      text-align: center;
    }
  }
</style>
